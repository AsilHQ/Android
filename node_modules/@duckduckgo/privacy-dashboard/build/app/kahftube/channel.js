if (!Array.prototype.last) {
	Array.prototype.last = function() {
		return this[this.length - 1];
	};
}

/*const restrictionImageUrl =
  "http://localhost:8080/assets/images/img_do_not_enter.jpeg";
const loadingImageUrl = "http://localhost:8080/assets/images/loading.gif";
const cautionImageUrl = "http://localhost:8080/assets/images/caution.png";*/
const restrictionImageUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALoAAACUCAMAAAATdsOFAAAAY1BMVEX///8AAABGRkb8/Pxqamq2trbm5ub5+fmUlJQTExPz8/PX19fv7+/s7OwbGxvIyMiNjY0hISGmpqY6Ojrf399AQEBycnKdnZ19fX28vLwtLS2Dg4NiYmJLS0vPz89cXFxTU1N1fC1jAAAFIElEQVR4nO2caZeqMAyGQUCkOGyyDIvo//+V17FtilDAcVLoPafvJ8fhhIcuIU1TLcvIyMjIyMjIyMjIyMjIyMhoUSSuTupU1UQV+NFtUlulouYWKgH/VorN1eHDx8Um5LadZg4yudqh8qIWlTy8bEeOy368bUlu2yc0cufETDbfoa9OYcv7Nqix0MOIWjzEWBZnlHMvdvvCMegk1F7R49hbkM/710Oyx8yh9eLSvVi7Fz6KuZhaS5D9rVzcI+Qo1uh4Sbdo9Ic8il6hGLs/bd2PKMZWldPbdSjGDk9b7ibj5THaXerNUIxti+4Y9KcM+lN5nVVVVi+4Pk3R4/L6DJ7TezK7otAT/TsSwWE694bTET0fxfyXs/QyDdHZq2agQhoe6ofO3jQv+pbFWPqhZwAciE+y0FY/dGjp3Cch7wFXMmS0Q2fxYMNWKzVjlyy7tEOnPEHG/64oejU1qh06dYx3mJdfNCNVTrOMuqH7DR3o8AVp6bNMfbum6In4gq6fD9N5qil6CV+wVr/p3+oWHdoFLBJzNoL0H+tWST0KZORYziKbXqkdek9RA7bQZ0mp4H/w6xaPdwsvD7OG/SHxjRqiszzUi1JZDlM/dL+dokvTRPqhW+duTF5K84oaoltkFLFLo3U90R/hYwPcwWUuDa0nunWu3GsTBM3VzeQLU0tb9MdszWPPi/OF7Lm26Osy6FQG/U3tju58vI21NzpJrp/ebWf0sPh8M2hXdFIthCir2hMdclvJR+z7ofuZyEV/VGCxGzrpRDb0s33bvdDHa6HFKoXkINtS2gddVLY1bNQsFLacy8dCVZdldX3g5Pe4Z+yXuRKa/FnGkE6zGTugkxYq207HBxr7fJFv1fVX7obGZrdH78VWUf28kg/7RrZjNCjgGyfAtkYnCaCUHBWm7NS9V8OpfHjtl43RQ1jtF4PB6/GSsVG7k1Fe47XSZlN04oEvd4ct6PCtr+6F/QiZAXjg4WTdEj0vOUE0Wiz7fGCUg+9DPkHtWDjTRFywIXoNM07iTPhTiXrRmCc0msfVPkwRF9g3QyfQ6VEi+z8f1nxTACYo6wh48IA/90bofg2x1l3+7jnzdq9+/IxwRAkf/r0YP86G6F9JOkGZXMPLgTNHPMcwLsuh3yqyGXoMDRbF86E522a0oxogXyMb4Sufb6ct0CuobrktnrHgxakR76LLuMAWJkBBtkAP4cXfrNXfHkWW9EfdNNQFt2OHfGNbGTrJYJSX64cr+mERj2TTbtgQnl8qRc/FkZPsnQM5olXtk3xWfHGLUXJXie5BK97erAvnlRjR7BkSwsu/g0AdunBxwftrflpUMrvw+BF/PFsVutOD9etvSvF/vMh1+SxAWChFP/J+tdP2V4cSnERE8nPKXYXoPRyVudS/zPySN07YnVtl6BV4inJ2L+hP8jMl6BYB5ystlcMRX7Vionc1NLmLc5BCLjZZMdEjHrKk8xuHKMIPBMAlKjkSKqQg/GJK1Da5OnTlR9mUof/uLfSZlKBfJJVa+FKB7iqen0wK0DucA32r2nvf9A8y6FQG/U0ZdCq6vLiqDBcHQj20ydZ0OOduV3XEPCrLNuMWl/N4YssCnIbyWdql2aLdeQEt0sF/yJBEbZwflQrW7Ui/ckMgabSZ0E7+59f1m6EqxQv18sP67TB1QnyJjMug1erD2qs59fdo/Z4oStE9mRO3XZEGahUVXavktX3ua0+t6l7Zb38ZGRkZGRkZGRkZGRkZGRkJ/QP0HkeQHvo5hgAAAABJRU5ErkJggg==";
const loadingImageUrl = "https://cdn.cssauthor.com/wp-content/uploads/2018/06/Silver-Balls-Swinging.gif?strip=all&lossy=1&resize=800%2C600&ssl=1";
const cautionImageUrl = "data:image/jpeg;base64,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";


let isSubscriptionClicked = false;
let isElementClicked = false;
let mode;
let gender;
let token;

let channels = {};
let length = 0;
let allChannels = [];
try {
	allChannels =
		ytInitialData.contents.singleColumnBrowseResultsRenderer.tabs[0].tabRenderer.content.sectionListRenderer.contents[0].itemSectionRenderer.contents.map(
			(e) => {
				return {
					id: e.channelListItemRenderer.channelId,
					name: e.channelListItemRenderer.title.runs[0].text,
					isUnsubscribed: false,
					thumbnail: `https:${e.channelListItemRenderer.thumbnail.thumbnails[0].url}`,
					isHaram: false,
				};
			}
		);
} catch (error) {}
allChannels = allChannels ?? [];

function check_gender(response_gender, gender) {
	if (response_gender == 1) return true;
	if (response_gender == 4) return true; //Kids items are halal for both male and female.
	return response_gender == gender;
}

function check_mode(response_mode, mode) {
	switch (mode) {
		case 2:
			return true;
		case 3:
			return response_mode == 3 || response_mode == 1;
		case 1:
			return response_mode === 1;
		default:
			return false;
	}
}

function can_see(response) {
	return (
		check_gender(response.permissible_for.value, gender) &&
		check_mode(response.practicing_level.value, mode)
	);
}

async function canSeee(responsee) {
	if (responsee["type"]) {
		return true;
	}
	return can_see(responsee);
}

async function getParamsBasedOnResponse(response) {
	if (response == 404) {
		return {
			imageUrl: cautionImageUrl,
			action: "",
		};
	} else if (response?.is_halal) {
		if (await canSeee(response)) {
			return {
				action: "",
			};
		} else {
			return {
				imageUrl: restrictionImageUrl,
				action: "none",
			};
		}
	} else if (response == "loading") {
		return {
			imageUrl: loadingImageUrl,
			action: "none",
		};
	} else {
		return {
			imageUrl: restrictionImageUrl,
			action: "none",
		};
	}
}

(async () => {
	/*const pref = await window.flutter_inappwebview.callHandler("pref");
	mode = pref["mode"];
	gender = pref["gender"];
	token = pref["token"];*/
	token = KahfTubeInterface.getUserToken();
	mode = KahfTubeInterface.getUserPracticingLevel();
	gender = KahfTubeInterface.getUserGender();

	/*token = "1637|VTwoGKekKw5uLze11HEwQc1kExtFnkuqts0chlOw1c46b4ff"
	mode = 1
	gender = 2*/
	if (token == "") {
		token = "1637|VTwoGKekKw5uLze11HEwQc1kExtFnkuqts0chlOw1c46b4ff"
	}

	console.log("userPref:", token)
	console.log("userPref:", mode)
	console.log("userPref:", gender)

	const channelIds = allChannels.map((e) => e.id);
	const res = await fetch(
		"https://api.kahf.ai/api/v1/channels?ids[]=" + channelIds.join("&ids[]="),

		{
			headers: {
				"Content-Type": "application/json",
				Accept: "application/json",
				Authorization: `Bearer ${token}`,
			},
		}
	);

	const response = await res.json();
	// console.log("------LOL-------");
	console.log("channel response:",JSON.stringify(response));

	for (const element of allChannels) {
		// console.log(href);
		const fIndex = response.data?.findIndex((el) => element.id.includes(el.id));
		// console.log(fIndex);
		if (fIndex > -1) {
			const {
				imageUrl
			} = await getParamsBasedOnResponse(
				response.data[fIndex]
			);
			element["isHaram"] = imageUrl == restrictionImageUrl;
		}
	}

	console.log(JSON.stringify(allChannels));

	//const value = await window.flutter_inappwebview.callHandler("getChannels",allChannels);
	const value = await KahfTubeInterface.getChannels(JSON.stringify(allChannels));
})();