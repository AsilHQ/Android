let isButtonClicked = false;
let isAccountClicked = false;
let isMethodCalled = false;
let isAccountPressed = false;
let isVideoClicked = false;
setTimeout(() => {
  const accountButton = document.querySelector(
    "div.setting-generic-category-title"
  );
  //console.log("buttonElement:: accountButton:", accountButton);
  accountButton?.click();
}, 1000);

new MutationObserver(() => {
  const videoPreview = document.querySelectorAll(
    "button.c3-material-toggle-button"
  )[1];
  if (videoPreview?.isConnected) {
    if (videoPreview?.getAttribute("aria-pressed")) {
      if (videoPreview?.getAttribute("aria-pressed") === "true") {
        if (!isVideoClicked) {
          isVideoClicked = true;
          videoPreview.click();
        } else {
          // console.log("POLOA");
          if (document.getElementById("toasts").children.length == 1) {
            if (!isAccountPressed) {
              isAccountPressed = true;
              //location.href = "https://m.youtube.com";
            }
          }
        }
      } else {
        if (!isAccountPressed) {
          isAccountPressed = true;
          //location.href = "https://m.youtube.com";
        }
      }
    }
  }

  /*const button = document
    .querySelector("ytm-topbar-menu-button-renderer")
    .children.item(0);*/

    const buttonElement = document.querySelector("ytm-topbar-menu-button-renderer");

    if (buttonElement && buttonElement.children.length > 0) {
        const button = buttonElement.children.item(0);

        if (button) {
            // Now you can work with the first child element
            console.log("buttonElement:: button:", button);
            if (!isButtonClicked && button.isConnected) {
                isButtonClicked = true;
                button.click();
              }
        } else {
            console.error("buttonElement:: First child element not found");
        }
    } else {
        console.error("buttonElement:: Button element not found");
    }

  const image = document
    .querySelector("ytm-topbar-menu-button-renderer")
    ?.querySelector("ytm-profile-icon")
    ?.querySelector("img");

    //console.log("buttonElement:: image:", image);
  if (image) {
    const account = document.querySelector("div.active-account-name");

    if (!isAccountClicked && account?.isConnected) {
      isAccountClicked = true;
      account.click();
    }
    const holder = document.querySelector("div.google-account-header-renderer");
    //console.log("buttonElement:: holder:", holder);
    if (holder?.isConnected) {
      const email = holder.children.item(1).textContent;
      // console.log("Jashem");
      // console.log(email);
      const name = holder.children.item(0).textContent;
      const imgSrc = image.getAttribute("src");
      if (!isMethodCalled) {
        isMethodCalled = true;
        //console.log("name: ",name);
        //console.log("email: ",email);
        //console.log("imgSrc: ",imgSrc);
        location.href = "https://m.youtube.com";
        KahfTubeInterface.callHandler(name, email, imgSrc);
      }
    }
  } else if (isButtonClicked) {
    if (!isMethodCalled) {
      isMethodCalled = true;
      //console.log("callHandler else if");
      location.href = "https://m.youtube.com";
      KahfTubeInterface.callHandler(null,null,null);
    }
  }
}).observe(document, { subtree: true, childList: true });
